"""
–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (regex)
"""
import re
from typing import Optional, Dict
from datetime import datetime, timedelta
from loguru import logger


class MessageExtractor:
    """–ö–ª–∞—Å—Å –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π"""

    # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞
    # –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (—Å–Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å!)

    # –†–ê–ë–û–¢–û–î–ê–¢–ï–õ–¨ (–∏—â–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤) - –ü–†–ò–û–†–ò–¢–ï–¢!
    EMPLOYER_KEYWORDS = [
        # –Ø–≤–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è
        "—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫", "—Ç—Ä–µ–±—É—é—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫", "—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–±–æ—Ç–Ω–∏–∫",
        "—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä", "—Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–º–µ–Ω–∞",
        "–Ω—É–∂–µ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫", "–Ω—É–∂–Ω—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫", "–Ω—É–∂–µ–Ω —Ä–∞–±–æ—Ç–Ω–∏–∫", "–Ω—É–∂–Ω—ã —Ä–∞–±–æ—Ç–Ω–∏–∫",
        "–Ω—É–∂–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏—Ü–∞", "–Ω—É–∂–Ω—ã —Å–æ—Ç—Ä—É–¥–Ω–∏—Ü",
        "–∏—â—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", "–∏—â–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", "–∏—â–µ–º —Ä–∞–±–æ—Ç–Ω–∏–∫–∞",
        "–∏—â—É —Ä–∞–±–æ—Ç–Ω–∏–∫–∞", "–∏—â—É –Ω–∞ –∑–∞–º–µ–Ω—É", "–∏—â–µ–º –Ω–∞ –∑–∞–º–µ–Ω—É",
        "–Ω—É–∂–Ω–∞ –¥–µ–≤–æ—á–∫–∞", "–Ω—É–∂–µ–Ω –ø–∞—Ä–µ–Ω—å", "–Ω—É–∂–Ω–∞ –¥–µ–≤—É—à–∫–∞", "–Ω—É–∂–µ–Ω –º—É–∂—á–∏–Ω–∞",
        "—Ç—Ä–µ–±—É—é—Ç—Å—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∏", "–Ω—É–∂–Ω—ã —Ä–∞–±–æ—Ç–Ω–∏–∫–∏",

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        "–Ω—É–∂–Ω–∞ –∑–∞–º–µ–Ω–∞", "–Ω—É–∂–µ–Ω –Ω–∞ –∑–∞–º–µ–Ω—É", "–Ω—É–∂–Ω–∞ –Ω–∞ –∑–∞–º–µ–Ω—É",
        "–∏—â—É –∑–∞–º–µ–Ω—É", "–∏—â–µ–º –∑–∞–º–µ–Ω—É", "–∏—â–µ—Ç—Å—è –∑–∞–º–µ–Ω–∞",
        "—Å—Ä–æ—á–Ω–æ –Ω—É–∂–µ–Ω", "—Å—Ä–æ—á–Ω–æ –Ω—É–∂–Ω–∞", "—Å—Ä–æ—á–Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è",
        "—Ç—Ä–µ–±—É—é—Ç—Å—è –Ω–∞", "–Ω—É–∂–Ω—ã –Ω–∞",
        "–ø—Ä–∏–≥–ª–∞—à–∞–µ–º –Ω–∞ —Ä–∞–±–æ—Ç—É", "–ø—Ä–∏–≥–ª–∞—à–∞–µ–º –≤ –∫–æ–º–∞–Ω–¥—É",
        "–≤–∞–∫–∞–Ω—Å–∏—è", "–æ—Ç–∫—Ä—ã—Ç–∞ –≤–∞–∫–∞–Ω—Å–∏—è",
        "–Ω–∞–±–∏—Ä–∞–µ–º", "–Ω–∞–±–∏—Ä–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤", "–Ω–∞–±–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",
        "–∏—â–µ–º –≤ –∫–æ–º–∞–Ω–¥—É", "–≤ –∫–æ–º–∞–Ω–¥—É –Ω—É–∂–µ–Ω", "–≤ –∫–æ–º–∞–Ω–¥—É –Ω—É–∂–Ω–∞",

        # –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ (–≤–∞–∫–∞–Ω—Å–∏—è)
        "–Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É", "–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∏", "–ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞",
        "—Å –æ–ø—ã—Ç–æ–º –Ω–∞ –ø–≤–∑", "–æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞ –ø–≤–∑ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω",
        "—Ä–µ–∑—é–º–µ", "—Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ", "–≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã", "–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ —Ç–∫"
    ]

    # –†–ê–ë–û–¢–ù–ò–ö (–∏—â–µ—Ç —Ä–∞–±–æ—Ç—É)
    WORKER_KEYWORDS = [
        # –Ø–≤–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
        "–≥–æ—Ç–æ–≤ –≤—ã–π—Ç–∏", "–≤—ã–π–¥—É –Ω–∞ —Å–º–µ–Ω—É", "–≤—ã–π–¥—É –Ω–∞ –∑–∞–º–µ–Ω—É", "–≤—ã–π–¥—É",
        "–º–æ–≥—É –≤—ã–π—Ç–∏", "–º–æ–≥—É –Ω–∞", "–º–æ–≥—É –≤", "–º–æ–≥—É –∑–∞–≤—Ç—Ä–∞", "–º–æ–≥—É —Å–µ–≥–æ–¥–Ω—è", "–º–æ–≥—É",
        "–≤—ã—Ö–æ–∂—É –Ω–∞",
        "–∏—â—É —Ä–∞–±–æ—Ç—É", "–∏—â—É —Å–º–µ–Ω—É", "–∏—â—É –ø–æ–¥—Ä–∞–±–æ—Ç–∫—É",
        "–≤–æ–∑—å–º—É —Å–º–µ–Ω—É", "–≤–æ–∑—å–º—É –∑–∞–º–µ–Ω—É",
        "—Ä–∞—Å—Å–º–æ—Ç—Ä—é –≤–∞—Ä–∏–∞–Ω—Ç—ã", "—Ä–∞—Å—Å–º–æ—Ç—Ä—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è",
        "–µ—Å—Ç—å –æ–ø—ã—Ç", "–º–æ–π –æ–ø—ã—Ç", "—Ä–∞–±–æ—Ç–∞–ª –Ω–∞ –ø–≤–∑", "—Ä–∞–±–æ—Ç–∞–ª–∞ –Ω–∞ –ø–≤–∑"
    ]

    # Regex –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    PRICE_PATTERNS = [
        r'(\d{4,5})\s*(?:—Ä—É–±|‚ÇΩ|—Ä|—Ä—É–±–ª–µ–π)',
        r'(?:—Ü–µ–Ω–∞|–æ–ø–ª–∞—Ç–∞|–∑–ø|–∑–∞—Ä–ø–ª–∞—Ç–∞|–ø–ª–∞—Ç–∞)\s*[-:‚Äî]?\s*(?:–∑–∞\s+—Å–º–µ–Ω—É\s+)?(\d{4,5})',
        r'\b(\d{4,5})\b',  # –ü—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ 4-5 —Ü–∏—Ñ—Ä (–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
    ]

    SHK_PATTERNS = [
        r'—à–∫\s*[-:‚Äî]\s*(\d+)',
        r'—à–∫\s*[-:‚Äî]?\s*(–º–∞–ª–æ|–º–Ω–æ–≥–æ|—Å—Ä–µ–¥–Ω–µ)',
        r'—à—Ç—Ä–∏—Ö–∫–æ–¥[–∞-—è—ë]*\s*[-:‚Äî]?\s*(\d+)',
    ]

    DATE_PATTERNS = [
        r'(—Å–µ–≥–æ–¥–Ω—è|–∑–∞–≤—Ç—Ä–∞|–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞)',
        r'(\d{1,2})\s+(—è–Ω–≤–∞—Ä—è|—Ñ–µ–≤—Ä–∞–ª—è|–º–∞—Ä—Ç–∞|–∞–ø—Ä–µ–ª—è|–º–∞—è|–∏—é–Ω—è|–∏—é–ª—è|–∞–≤–≥—É—Å—Ç–∞|—Å–µ–Ω—Ç—è–±—Ä—è|–æ–∫—Ç—è–±—Ä—è|–Ω–æ—è–±—Ä—è|–¥–µ–∫–∞–±—Ä—è)',
        r'(\d{1,2})[./](\d{1,2})',
    ]

    LOCATION_PATTERN = r'(?:–≤\s+|–≥\.?\s+|–≥–æ—Ä–æ–¥\s+)?([–ê-–Ø–Å][–∞-—è—ë]+(?:\s+[–ê-–Ø–Å][–∞-—è—ë]+)?)'

    MONTHS = {
        '—è–Ω–≤–∞—Ä—è': 1, '—Ñ–µ–≤—Ä–∞–ª—è': 2, '–º–∞—Ä—Ç–∞': 3, '–∞–ø—Ä–µ–ª—è': 4,
        '–º–∞—è': 5, '–∏—é–Ω—è': 6, '–∏—é–ª—è': 7, '–∞–≤–≥—É—Å—Ç–∞': 8,
        '—Å–µ–Ω—Ç—è–±—Ä—è': 9, '–æ–∫—Ç—è–±—Ä—è': 10, '–Ω–æ—è–±—Ä—è': 11, '–¥–µ–∫–∞–±—Ä—è': 12
    }

    @staticmethod
    def detect_type(text: str) -> Optional[str]:
        """
        –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è (—Ä–∞–±–æ—Ç–Ω–∏–∫/—Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å)

        –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –°–ù–ê–ß–ê–õ–ê employer (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!),
        —Ç.–∫. –µ–≥–æ –ø—Ä–∏–∑–Ω–∞–∫–∏ –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ
        """
        text_lower = text.lower()

        # 1. –°–ù–ê–ß–ê–õ–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º EMPLOYER (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!)
        for keyword in MessageExtractor.EMPLOYER_KEYWORDS:
            if keyword in text_lower:
                return "employer"

        # 2. –ü–æ—Ç–æ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º WORKER
        for keyword in MessageExtractor.WORKER_KEYWORDS:
            if keyword in text_lower:
                return "worker"

        return None

    @staticmethod
    def extract_price(text: str) -> Optional[int]:
        """–ò–∑–≤–ª–µ—á—å —Ü–µ–Ω—É"""
        text = text.lower()

        for pattern in MessageExtractor.PRICE_PATTERNS:
            match = re.search(pattern, text)
            if match:
                try:
                    price = int(match.group(1))
                    if 1000 <= price <= 99999:  # –†–∞–∑—É–º–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è —Ü–µ–Ω—ã –∑–∞ —Å–º–µ–Ω—É
                        return price
                except (ValueError, IndexError):
                    continue

        return None

    @staticmethod
    def extract_shk(text: str) -> Optional[str]:
        """–ò–∑–≤–ª–µ—á—å –®–ö (—à—Ç—Ä–∏—Ö–∫–æ–¥—ã)"""
        text = text.lower()

        for pattern in MessageExtractor.SHK_PATTERNS:
            match = re.search(pattern, text)
            if match:
                return match.group(1)

        return None

    @staticmethod
    def extract_date(text: str, message_date: datetime) -> Optional[str]:
        """–ò–∑–≤–ª–µ—á—å –¥–∞—Ç—É"""
        text = text.lower()

        # –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞—Ç—ã (–ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
        if '–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞' in text:
            return (message_date + timedelta(days=2)).date().isoformat()
        elif '–∑–∞–≤—Ç—Ä–∞' in text:
            return (message_date + timedelta(days=1)).date().isoformat()
        elif '—Å–µ–≥–æ–¥–Ω—è' in text or '—Å–µ–π—á–∞—Å' in text:
            return message_date.date().isoformat()

        # –î–∞—Ç–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –º–µ—Å—è—Ü–∞ (15 —Ñ–µ–≤—Ä–∞–ª—è)
        month_pattern = r'(\d{1,2})\s+(—è–Ω–≤–∞—Ä—è|—Ñ–µ–≤—Ä–∞–ª—è|–º–∞—Ä—Ç–∞|–∞–ø—Ä–µ–ª—è|–º–∞—è|–∏—é–Ω—è|–∏—é–ª—è|–∞–≤–≥—É—Å—Ç–∞|—Å–µ–Ω—Ç—è–±—Ä—è|–æ–∫—Ç—è–±—Ä—è|–Ω–æ—è–±—Ä—è|–¥–µ–∫–∞–±—Ä—è)'
        match = re.search(month_pattern, text)
        if match:
            day = int(match.group(1))
            month_name = match.group(2)
            month = MessageExtractor.MONTHS.get(month_name)
            if month and 1 <= day <= 31:
                year = message_date.year
                try:
                    return datetime(year, month, day).date().isoformat()
                except ValueError:
                    pass

        # –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 15.02 –∏–ª–∏ 15/02
        date_pattern = r'(\d{1,2})[./](\d{1,2})'
        match = re.search(date_pattern, text)
        if match:
            day = int(match.group(1))
            month = int(match.group(2))
            if 1 <= day <= 31 and 1 <= month <= 12:
                year = message_date.year
                try:
                    return datetime(year, month, day).date().isoformat()
                except ValueError:
                    pass

        return None

    @staticmethod
    def extract_location(text: str) -> Optional[str]:
        """–ò–∑–≤–ª–µ—á—å –ª–æ–∫–∞—Ü–∏—é (–≥–æ—Ä–æ–¥) - —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏"""
        # –ò—â–µ–º —Å–ª–æ–≤–∞ —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤)
        matches = re.findall(MessageExtractor.LOCATION_PATTERN, text)

        # –ò—Å–∫–ª—é—á–∞–µ–º –æ–±—â–∏–µ —Å–ª–æ–≤–∞
        excluded = {'–ì–æ—Ç–æ–≤', '–í—ã–π–¥—É', '–ú–æ–≥—É', '–†–∞–±–æ—Ç–∞', '–ò—â—É', '–ù—É–∂–µ–Ω', '–¢—Ä–µ–±—É–µ—Ç—Å—è'}

        for match in matches:
            if match not in excluded:
                return match

        return None

    @staticmethod
    def extract_location_structured(text: str, topic_name: Optional[str] = None) -> dict:
        """
        –£–º–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏ (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ)

        –ò–∑–≤–ª–µ–∫–∞–µ—Ç:
        - city: –ì–æ—Ä–æ–¥ (–ú–æ—Å–∫–≤–∞, –°–ü–ë) - –∏–∑ —Ç–æ–ø–∏–∫–∞ –∏–ª–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞
        - metro_station: –°—Ç–∞–Ω—Ü–∏—è –º–µ—Ç—Ä–æ (–í–æ–¥–Ω—ã–π —Å—Ç–∞–¥–∏–æ–Ω, –í—ã—Ö–∏–Ω–æ)
        - district: –†–∞–π–æ–Ω (–Æ–í–ê–û, –Æ–ê–û, –¶–ê–û)

        Args:
            text: —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            topic_name: –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ú–°–ö - Ozon")

        Returns:
            dict —Å –∫–ª—é—á–∞–º–∏: city, metro_station, district
        """
        text_lower = text.lower()

        result = {
            'city': None,
            'metro_station': None,
            'district': None
        }

        # 1. –ì–û–†–û–î (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ç–æ–ø–∏–∫ ‚Üí —Ç–µ–∫—Å—Ç)

        # –ò–∑ —Ç–æ–ø–∏–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if topic_name:
            topic_lower = topic_name.lower()
            if '–º—Å–∫' in topic_lower or '–º–æ—Å–∫–≤–∞' in topic_lower:
                result['city'] = '–ú–æ—Å–∫–≤–∞'
            elif '—Å–ø–±' in topic_lower or '–ø–∏—Ç–µ—Ä' in topic_lower or '—Å–∞–Ω–∫—Ç' in topic_lower:
                result['city'] = '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥'

        # –ò–∑ —Ç–µ–∫—Å—Ç–∞ (–µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ —Ç–æ–ø–∏–∫–µ)
        if not result['city']:
            CITIES = {
                '–º–æ—Å–∫–≤–∞': '–ú–æ—Å–∫–≤–∞',
                '–º—Å–∫': '–ú–æ—Å–∫–≤–∞',
                'moscow': '–ú–æ—Å–∫–≤–∞',
                '—Å–ø–±': '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
                '–ø–∏—Ç–µ—Ä': '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
                '—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥': '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
                '–∑–µ–ª–µ–Ω–æ–≥—Ä–∞–¥': '–ó–µ–ª–µ–Ω–æ–≥—Ä–∞–¥',
                '–º–æ': '–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
                '–ø–æ–¥–º–æ—Å–∫–æ–≤—å–µ': '–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å'
            }

            for key, city in CITIES.items():
                if key in text_lower:
                    result['city'] = city
                    break

        # 2. –ú–ï–¢–†–û

        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –º–µ—Ç—Ä–æ
        metro_patterns = [
            r'(?:–º–µ—Ç—Ä–æ|–º\.|–º—Ü–∫)\s+([–ê-–Ø–∞-—è–Å—ë\s]+?)(?:\s|,|\.|\n|$)',  # "–º–µ—Ç—Ä–æ –í–æ–¥–Ω—ã–π —Å—Ç–∞–¥–∏–æ–Ω"
            r'(?:^|\n)([–ê-–Ø][–∞-—è]+(?:\s[–ê-–Ø][–∞-—è]+)?)\s+–º–µ—Ç—Ä–æ',  # "–í—ã—Ö–∏–Ω–æ –º–µ—Ç—Ä–æ"
        ]

        for pattern in metro_patterns:
            match = re.search(pattern, text, re.IGNORECASE)
            if match:
                station = match.group(1).strip()
                # –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–µ —Å–ª–æ–≤–∞
                if len(station) > 3 and station.lower() not in ['–ª—é–±–æ–µ', '–Ω–µ –≤–∞–∂–Ω–æ', '–ª—é–±–æ–π']:
                    result['metro_station'] = station.title()
                    break

        # 3. –†–ê–ô–û–ù (–æ–∫—Ä—É–≥–∞ –ú–æ—Å–∫–≤—ã)

        DISTRICTS = ['—é–∞–æ', '—é–≤–∞–æ', '—Ü–∞–æ', '—Å–∞–æ', '—Å–≤–∞–æ', '—Å–∑–∞–æ', '–∑–∞–æ', '—é–∑–∞–æ']

        for district in DISTRICTS:
            if district in text_lower:
                result['district'] = district.upper()
                break

        return result

    @staticmethod
    def extract(text: str, message_date: datetime) -> Optional[Dict]:
        """
        –ò–∑–≤–ª–µ—á—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è

        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –ø–æ–ª—è–º–∏:
        - type: "worker" –∏–ª–∏ "employer"
        - price: int
        - date: str (ISO format)
        - shk: Optional[str]
        - location: Optional[str]
        """
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–Ω—É (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
        price = MessageExtractor.extract_price(text)
        if not price:
            logger.debug(f"–¶–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏: {text[:50]}...")
            return None

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
        work_date = MessageExtractor.extract_date(text, message_date)
        if not work_date:
            logger.debug(f"–î–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏: {text[:50]}...")
            return None

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø
        msg_type = MessageExtractor.detect_type(text)

        # FALLBACK LOGIC: –µ—Å–ª–∏ —Ç–∏–ø –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω, –Ω–æ –µ—Å—Ç—å —Ü–µ–Ω–∞+–¥–∞—Ç–∞,
        # —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ —Ä–∞–±–æ—Ç–Ω–∏–∫ (—Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–∏ –ø–∏—à—É—Ç –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ)
        if not msg_type:
            # –ö–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ü–µ–Ω–æ–π –∏ –¥–∞—Ç–æ–π = —Ä–∞–±–æ—Ç–Ω–∏–∫–∏
            if len(text) < 100:  # –ö–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                logger.debug(f"Fallback: –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ü–µ–Ω–æ–π+–¥–∞—Ç–æ–π ‚Üí worker: {text[:50]}...")
                msg_type = "worker"
            else:
                logger.debug(f"–¢–∏–ø –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏: {text[:50]}...")
                return None

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
        shk = MessageExtractor.extract_shk(text)
        location = MessageExtractor.extract_location(text)

        return {
            'type': msg_type,
            'price': price,
            'date': work_date,
            'shk': shk,
            'location': location
        }


# –¢–µ—Å—Ç—ã
if __name__ == "__main__":
    test_messages = [
        "–ì–æ—Ç–æ–≤ –≤—ã–π—Ç–∏ —Å–µ–≥–æ–¥–Ω—è, —Ü–µ–Ω–∞ –∑–∞ —Å–º–µ–Ω—É 3000",
        "–í—ã–π–¥—É –Ω–∞ –∑–∞–º–µ–Ω—É, –∑–∞–≤—Ç—Ä–∞, –æ–ø–ª–∞—Ç–∞ 2500 —Ä—É–±",
        "–ú–æ–≥—É 15 —Ñ–µ–≤—Ä–∞–ª—è, 2800‚ÇΩ, —à–∫ - 100",
        "–†–∞–±–æ—Ç–∞ –ü–í–ó, –ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞, 3500, —à–∫ –º–∞–ª–æ",
        "–ò—â—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞ –∑–∞–º–µ–Ω—É, –ú—ã—Ç–∏—â–∏, 20 —Ñ–µ–≤—Ä–∞–ª—è, 2800",
        "–ù—É–∂–µ–Ω —Ä–∞–±–æ—Ç–Ω–∏–∫ –≤ –ü–í–ó, –∑–∞–≤—Ç—Ä–∞, –æ–ø–ª–∞—Ç–∞ 3000 —Ä, —à–∫ - 200",
        "15.02 –º–æ–≥—É –≤—ã–π—Ç–∏, –∑–ø 3200, —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ 150"
    ]

    test_date = datetime(2026, 2, 1, 12, 0, 0)

    for msg in test_messages:
        print(f"\nüìù –¢–µ—Å—Ç: {msg}")
        result = MessageExtractor.extract(msg, test_date)
        if result:
            print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: {result}")
        else:
            print("‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã")
