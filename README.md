# Workers Service

ะะธะบัะพัะตัะฒะธั ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ ะฟัะฑะปะธัะฝัั Telegram ัะฐัะพะฒ ะธ ะฟะพะธัะบะฐ ะพะฑััะฒะปะตะฝะธะน ะพ ัะฐะฑะพัะต ะฝะฐ ะะะ (ะฟัะฝะบัั ะฒัะดะฐัะธ ะทะฐะบะฐะทะพะฒ).

## ะะพะทะผะพะถะฝะพััะธ

- ๐ ะะพะฝะธัะพัะธะฝะณ ะฟัะฑะปะธัะฝัั Telegram ัะฐัะพะฒ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
- ๐ท ะะพะธัะบ ัะฐะฑะพัะฝะธะบะพะฒ (ัะตะถะธะผ `worker`)
- ๐ข ะะพะธัะบ ะฒะฐะบะฐะฝัะธะน (ัะตะถะธะผ `employer`)
- ๐ ะะทะฒะปะตัะตะฝะธะต ะดะฐะฝะฝัั: ะดะฐัะฐ, ัะตะฝะฐ, ะจะ, ะปะพะบะฐัะธั, ะผะตััะพ
- ๐ ะฃะฒะตะดะพะผะปะตะฝะธั ะฒ Telegram ะฑะพั
- ๐ซ ะะตะดัะฟะปะธะบะฐัะธั ัะพะพะฑัะตะฝะธะน (ะฟะพ ะบะพะฝัะตะฝัั ะธ ะฐะฒัะพัั)
- ๐ท๏ธ ะะพะดะดะตัะถะบะฐ ัะพะฟะธะบะพะฒ (ัะพััะผั Telegram)
- โซ **ะัะพะฒะตัะบะฐ ะฒ ะงะตัะฝะพะผ ะกะฟะธัะบะต** (ะฟะพะธัะบ ะฟะพ ะฝะตัะบะพะปัะบะธะผ ัะฐัะฐะผ ะงะก)
- ๐ ะฅัะฐะฝะตะฝะธะต ะฒ SQLite

## ะขะตัะฝะพะปะพะณะธัะตัะบะธะน ััะตะบ

- **FastAPI** - REST API
- **Pyrogram** - ััะตะฝะธะต Telegram (MTProto)
- **python-telegram-bot** - ะพัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน
- **SQLite + aiosqlite** - ะฑะฐะทะฐ ะดะฐะฝะฝัั
- **Pydantic** - ะฒะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั
- **Docker** - ะบะพะฝัะตะนะฝะตัะธะทะฐัะธั

## ะัััััะน ััะฐัั

### ะะพะบะฐะปัะฝัะน ะทะฐะฟััะบ

```bash
# 1. ะะปะพะฝะธัะพะฒะฐัั
git clone https://github.com/yourusername/workers_service.git
cd workers_service

# 2. ะะฐัััะพะธัั ะพะบััะถะตะฝะธะต
cp .env.example .env
# ะััะตะดะฐะบัะธััะนัะต .env

# 3. ะฃััะฐะฝะพะฒะธัั ะทะฐะฒะธัะธะผะพััะธ
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

# 4. ะะฒัะพัะธะทะฐัะธั Telegram (ะพะดะธะฝ ัะฐะท)
python auth_telegram.py

# 5. ะะฐะฟััะบ
python api.py
```

### Docker (ัะตะบะพะผะตะฝะดัะตััั ะดะปั ะฟัะพะดะฐะบัะตะฝะฐ)

```bash
# 1. ะะพะดะณะพัะพะฒะบะฐ
mkdir -p data/sessions data/db data/logs
cp workers_session.session data/sessions/

# 2. ะะฐัััะพะนะบะฐ
cp .env.example .env
# ะััะตะดะฐะบัะธััะนัะต .env

# 3. ะะฐะฟััะบ
docker-compose up -d

# 4. ะัะพะฒะตัะบะฐ
docker-compose ps
docker-compose logs -f
```

## ะะพะฝัะธะณััะฐัะธั (.env)

```env
# Telegram API (my.telegram.org)
API_ID=12345678
API_HASH=your_api_hash

# Telegram Bot (@BotFather)
BOT_TOKEN=your_bot_token

# ะะพะปัะทะพะฒะฐัะตะปั
USER_ID=123456789
CHATS=pvz_zamena

# ะกะตัะฒะตั
HOST=0.0.0.0
PORT=8002

# ะััะธ
DB_PATH=workers.db
LOG_PATH=workers_service.log
SESSION_PATH=workers_session

# ะะฐััะธะฝะณ
PARSE_HISTORY_DAYS=3

# ะงะตัะฝัะน ัะฟะธัะพะบ (ะดะตัะพะปัะฝัะน ัะฐั, ะดะพะฟ. ัะฐัั ัะตัะตะท API)
BLACKLIST_CHAT=@Blacklist_pvz
```

## API Endpoints

### ะะพะฝะธัะพัะธะฝะณ

| ะะตัะพะด | Endpoint | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| GET | `/health` | Healthcheck |
| POST | `/workers/start` | ะะฐะฟััะบ ะผะพะฝะธัะพัะธะฝะณะฐ |
| GET | `/workers/status/{task_id}` | ะกัะฐััั ะทะฐะดะฐัะธ |
| POST | `/workers/stop/{task_id}` | ะััะฐะฝะพะฒะบะฐ |
| GET | `/workers/list/{task_id}` | ะกะฟะธัะพะบ ะฝะฐะนะดะตะฝะฝัั |

### ะงะตัะฝัะน ัะฟะธัะพะบ

| ะะตัะพะด | Endpoint | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| POST | `/blacklist/check?username=@user` | ะัะพะฒะตัะธัั ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพ username |
| GET | `/blacklist/chats` | ะกะฟะธัะพะบ ัะฐัะพะฒ ะงะก |
| POST | `/blacklist/chats/add?chat_username=@chat` | ะะพะฑะฐะฒะธัั ัะฐั ะงะก |
| POST | `/blacklist/chats/remove?chat_username=@chat` | ะฃะดะฐะปะธัั ัะฐั ะงะก |

### Admin (ะผะพะฝะธัะพัะธะฝะณ ะธ ะพะฑัะปัะถะธะฒะฐะฝะธะต)

| ะะตัะพะด | Endpoint | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| GET | `/admin/stats` | ะกัะฐัะธััะธะบะฐ ะะ (ะบะพะป-ะฒะพ ะทะฐะฟะธัะตะน, ะดะฐัั) |
| POST | `/admin/cleanup?days=30` | ะััะฝะฐั ะพัะธััะบะฐ ััะฐััั ะทะฐะฟะธัะตะน |

### ะัะธะผะตั ะทะฐะฟััะบะฐ ะผะพะฝะธัะพัะธะฝะณะฐ

```bash
curl -X POST http://localhost:8002/workers/start \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": 123456789,
    "mode": "worker",
    "chats": ["@pvz_zamena"],
    "filters": {
      "date_from": "2026-02-04",
      "date_to": "2026-02-10",
      "min_price": 2000,
      "max_price": 5000,
      "shk_filter": "ะปัะฑะพะต"
    },
    "notification_bot_token": "BOT_TOKEN",
    "notification_chat_id": 123456789,
    "parse_history_days": 3,
    "api_id": 12345678,
    "api_hash": "your_api_hash"
  }'
```

## ะะตะถะธะผั ัะฐะฑะพัั

### Worker (ะฟะพะธัะบ ัะฐะฑะพัะฝะธะบะพะฒ)
ะะปััะตะฒัะต ัะปะพะฒะฐ: "ะณะพัะพะฒ ะฒัะนัะธ", "ะฒัะนะดั ะฝะฐ ะทะฐะผะตะฝั", "ะผะพะณั", "ะธัั ัะฐะฑะพัั"

### Employer (ะฟะพะธัะบ ะฒะฐะบะฐะฝัะธะน)
ะะปััะตะฒัะต ัะปะพะฒะฐ: "ััะตะฑัะตััั ัะพัััะดะฝะธะบ", "ะฝัะถะตะฝ ัะฐะฑะพัะฝะธะบ", "ะธัั ะฝะฐ ะทะฐะผะตะฝั", "ะฒะฐะบะฐะฝัะธั", "ะฝัะถะฝะฐ ะทะฐะผะตะฝะฐ"

## ะงะตัะฝัะน ัะฟะธัะพะบ

ะคัะฝะบัะธะพะฝะฐะป ะฟัะพะฒะตัะบะธ ัะฐะฑะพัะฝะธะบะพะฒ/ัะฐะฑะพัะพะดะฐัะตะปะตะน ะฒ ัะตัะฝัั ัะฟะธัะบะฐั Telegram.

### ะกัะตะฝะฐัะธะน 1: ะัะพะฒะตัะบะฐ ะธะท ัะฒะตะดะพะผะปะตะฝะธั
1. ะัะธัะพะดะธั ัะฒะตะดะพะผะปะตะฝะธะต ะพ ะฝะพะฒะพะผ ัะฐะฑะพัะฝะธะบะต/ะฒะฐะบะฐะฝัะธะธ
2. ะะฐะถะธะผะฐะตัะต ะบะฝะพะฟะบั "ะัะพะฒะตัะธัั ะฒ ะงะก"
3. ะกะธััะตะผะฐ ะฟะฐััะธั ะฒัะต ัะฐัั ะงะก ะธ ะธัะตั ัะพะฒะฟะฐะดะตะฝะธะต ะฟะพ User ID ะธะปะธ @username
4. ะะพะปััะฐะตัะต ัะตะทัะปััะฐั: ะฝะฐะนะดะตะฝ (ัะพ ัััะปะบะพะน ะฝะฐ ัะพะพะฑัะตะฝะธะต) ะธะปะธ ะฝะต ะฝะฐะนะดะตะฝ

### ะกัะตะฝะฐัะธะน 2: ะััะฝะฐั ะฟัะพะฒะตัะบะฐ ะฟะพ username
```bash
curl -X POST "http://localhost:8002/blacklist/check?username=@some_user"
```

### ะฃะฟัะฐะฒะปะตะฝะธะต ัะฐัะฐะผะธ ะงะก
```bash
# ะกะฟะธัะพะบ ัะฐัะพะฒ
curl http://localhost:8002/blacklist/chats

# ะะพะฑะฐะฒะธัั ัะฐั
curl -X POST "http://localhost:8002/blacklist/chats/add?chat_username=@Blacklist_pvz_2"

# ะฃะดะฐะปะธัั ัะฐั
curl -X POST "http://localhost:8002/blacklist/chats/remove?chat_username=@Blacklist_pvz_2"
```

### ะคะพัะผะฐั ะพัะฒะตัะฐ (ะฝะฐะนะดะตะฝ)
```json
{
  "found": true,
  "chat": "@Blacklist_pvz",
  "message_link": "https://t.me/Blacklist_pvz/1395",
  "extracted_info": {
    "user_id": 7228822372,
    "username": "@noppllo",
    "phone": "+79***462361"
  },
  "message_text": "..."
}
```

## ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะธััะบะฐ ะะ

ะกะตัะฒะธั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะดะฐะปัะตั ััะฐััะต ะทะฐะฟะธัะธ ะดะปั ะฟัะตะดะพัะฒัะฐัะตะฝะธั ะฟะตัะตะฟะพะปะฝะตะฝะธั ะะ.

### ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั
- โฐ **ะะฐะท ะฒ ัััะบะธ** (ัะพะฝะพะฒะฐั ะทะฐะดะฐัะฐ)
- ๐๏ธ ะฃะดะฐะปัะตั ะพะฑััะฒะปะตะฝะธั **ััะฐััะต 30 ะดะฝะตะน**
- ๐ ะะพะณะธััะตั ััะฐัะธััะธะบั ะะ
- ๐ ะะฐะฑะพัะฐะตั ะฒ production ะฑะตะท ะฒะผะตัะฐัะตะปัััะฒะฐ

### ะััะฝะฐั ะพัะธััะบะฐ (ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ)
```bash
# ะฃะดะฐะปะธัั ะทะฐะฟะธัะธ ััะฐััะต 30 ะดะฝะตะน (ะดะตัะพะปั)
curl -X POST "http://localhost:8002/admin/cleanup"

# ะฃะดะฐะปะธัั ะทะฐะฟะธัะธ ััะฐััะต 60 ะดะฝะตะน
curl -X POST "http://localhost:8002/admin/cleanup?days=60"
```

### ะกัะฐัะธััะธะบะฐ ะะ
```bash
curl http://localhost:8002/admin/stats
```

**ะัะฒะตั:**
```json
{
  "status": "success",
  "stats": {
    "tasks_count": 5,
    "found_items_count": 1240,
    "blacklist_cache_count": 0,
    "oldest_found_item": "2026-01-15T10:30:00",
    "newest_found_item": "2026-02-05T14:20:00"
  }
}
```

### ะัะตะฝะบะฐ ัะพััะฐ ะะ
- 1 ะฟะพะปัะทะพะฒะฐัะตะปั ร 20 ะพะฑััะฒะปะตะฝะธะน/ะดะตะฝั = **500 KB/ะผะตััั**
- 100 ะฟะพะปัะทะพะฒะฐัะตะปะตะน = **50 MB/ะผะตััั**
- ะก auto-cleanup (30 ะดะฝะตะน) = **~50 MB ััะฐะฑะธะปัะฝะพ**

## ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
workers_service/
โโโ api.py               # FastAPI ะฟัะธะปะพะถะตะฝะธะต
โโโ config.py            # ะะพะฝัะธะณััะฐัะธั ะธะท .env
โโโ tasks.py             # ะคะพะฝะพะฒัะต ะทะฐะดะฐัะธ
โโโ parser.py            # Telegram ะฟะฐััะตั (Pyrogram)
โโโ message_extractor.py # ะะทะฒะปะตัะตะฝะธะต ะดะฐะฝะฝัั (regex)
โโโ filters.py           # ะคะธะปัััะฐัะธั
โโโ db_service.py        # SQLite
โโโ tg_notifier.py       # ะฃะฒะตะดะพะผะปะตะฝะธั
โโโ deduplicator.py      # ะะตะดัะฟะปะธะบะฐัะธั
โโโ state_manager.py     # ะฃะฟัะฐะฒะปะตะฝะธะต ะทะฐะดะฐัะฐะผะธ
โโโ blacklist_service.py # ะะพะธัะบ ะฒ ัะตัะฝะพะผ ัะฟะธัะบะต
โโโ callback_handler.py  # ะะฑัะฐะฑะพัะบะฐ ะบะฝะพะฟะพะบ Telegram
โโโ models_api.py        # Pydantic ะผะพะดะตะปะธ
โโโ models_db.py         # ะะพะดะตะปะธ ะะ
โโโ auth_telegram.py     # ะะฒัะพัะธะทะฐัะธั Telegram
โโโ Dockerfile
โโโ docker-compose.yml
โโโ .env.example
โโโ requirements.txt
โโโ tests/               # ะขะตััั
```

## Docker ะบะพะผะฐะฝะดั

```bash
docker-compose up -d      # ะะฐะฟััะบ
docker-compose down       # ะััะฐะฝะพะฒะบะฐ
docker-compose restart    # ะะตัะตะทะฐะฟััะบ
docker-compose logs -f    # ะะพะณะธ
docker-compose ps         # ะกัะฐััั
```

## ะคะพัะผะฐั ัะฒะตะดะพะผะปะตะฝะธะน

### ะะฐะฑะพัะฝะธะบ (mode: worker)
```
๐ท ะะพะฒัะน ัะฐะฑะพัะฝะธะบ!

๐ ะะฐัะฐ: 15 ัะตะฒัะฐะปั 2026
๐ฐ ะฆะตะฝะฐ: 3000 ััะฑ/ัะผะตะฝั
๐ฆ ะจะ: 100
๐ท๏ธ ะขะพะฟะธะบ: [ะะกะ] -> OZON
๐๏ธ ะะพัะพะด: ะะพัะบะฒะฐ
๐ ะะตััะพ: ะะพะดะฝัะน ััะฐะดะธะพะฝ
๐ค @ivan_petrov
๐ฌ ะงะฐั: @pvz_zamena
๐ https://t.me/pvz_zamena/12345

๐ ะะพะปะฝัะน ัะตะบัั:
"ะะพัะพะฒ ะฒัะนัะธ 15 ัะตะฒัะฐะปั, ัะตะฝะฐ 3000, ัะบ 100"

[ะัะพะฒะตัะธัั ะฒ ะงะก] [ะะณะฝะพัะธัะพะฒะฐัั]
```

### ะะฐะบะฐะฝัะธั (mode: employer)
```
๐ข ะะพะฒะฐั ะฒะฐะบะฐะฝัะธั!

๐ ะะฐัะฐ: 20 ัะตะฒัะฐะปั 2026
๐ฐ ะะฟะปะฐัะฐ: 2800 ััะฑ/ัะผะตะฝั
๐ ะะพะบะฐัะธั: ะัะฑะตััั
๐ค @employer_user
๐ฌ ะงะฐั: @pvz_jobs
๐ https://t.me/pvz_jobs/67890

[ะัะพะฒะตัะธัั ะฒ ะงะก] [ะกะฒัะทะฐัััั] [ะะณะฝะพัะธัะพะฒะฐัั]
```

## ะขัะตะฑะพะฒะฐะฝะธั

- Python 3.11+
- Docker (ะดะปั ะฟัะพะดะฐะบัะตะฝะฐ)
- Telegram ะฐะบะบะฐัะฝั
- Telegram ะฑะพั

## ะะธัะตะฝะทะธั

MIT
